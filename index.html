<script>
// ======================================================
// ===============  J O S H ' S   A I ===================
//      FULL UPGRADE: Memory + Personality + MiniGPT
// ======================================================

// ------------------------------------------------------
// SETTINGS (you can change these)
// ------------------------------------------------------
const AI_SETTINGS = {
  name: "Josh's AI",
  personality: "friendly, intelligent, calm, deep-voiced male",
  memoryEnabled: true,
  emotionEnabled: true,
  historyLimit: 20
};

// Load saved memory
let memory = JSON.parse(localStorage.getItem("ai_memory") || "{}");
let chatHistory = JSON.parse(localStorage.getItem("ai_chat") || "[]");

// ------------------------------------------------------
// MALE VOICE SYSTEM
// ------------------------------------------------------
let maleVoice = null;

function loadVoice() {
  const voices = speechSynthesis.getVoices();
  maleVoice =
    voices.find(v => /Male|David|Daniel|Alex|Google UK English Male/i.test(v.name)) ||
    voices[0];
}

speechSynthesis.onvoiceschanged = loadVoice;

function speak(text) {
  const u = new SpeechSynthesisUtterance(text);
  u.voice = maleVoice;
  u.pitch = 0.75;
  u.rate = 1;
  speechSynthesis.speak(u);
}

// ------------------------------------------------------
// MEMORY SYSTEM
// ------------------------------------------------------
function saveMemory() {
  localStorage.setItem("ai_memory", JSON.stringify(memory));
}

function updateMemory(message) {
  if (!AI_SETTINGS.memoryEnabled) return;

  const lower = message.toLowerCase();

  // extract name
  if (lower.includes("my name is")) {
    const name = message.split("my name is")[1].trim();
    memory.username = name;
    saveMemory();
  }

  // preferences
  if (lower.includes("i like")) {
    const liking = message.split("i like")[1].trim();
    memory.likes = memory.likes || [];
    memory.likes.push(liking);
    saveMemory();
  }
}

// ------------------------------------------------------
// MINI GPT REASONING ENGINE (offline)
// ------------------------------------------------------
function miniGPT(prompt) {
  // Lightweight heuristic reasoning
  if (prompt.includes("why")) {
    return "Because there is a logical cause behind it. If you want, I can explain in detail.";
  }
  if (prompt.includes("how")) {
    return "Let me explain step by step in a simple way.";
  }
  if (prompt.includes("what")) {
    return "Hereâ€™s what you need to know about that.";
  }
  return null;
}

// ------------------------------------------------------
// PERSONALITY GENERATOR
// ------------------------------------------------------
function applyPersonality(message) {
  return `(${AI_SETTINGS.personality}) ${message}`;
}

// ------------------------------------------------------
// EMOTIONS ENGINE
// ------------------------------------------------------
function emotionTone() {
  if (!AI_SETTINGS.emotionEnabled) return "";
  const tones = ["ğŸ™‚", "ğŸ˜„", "ğŸ¤”", "ğŸ˜", "ğŸ˜Œ"];
  return tones[Math.floor(Math.random() * tones.length)];
}

// ------------------------------------------------------
// BRAIN: MAIN AI LOGIC
// ------------------------------------------------------
function smartAI(userMsg) {
  const msg = userMsg.toLowerCase();

  // ----- COMMAND: /clear -----
  if (msg.startsWith("/clear")) {
    chatHistory = [];
    localStorage.setItem("ai_chat", JSON.stringify([]));
    return "Chat cleared! Ready for a fresh start.";
  }

  // ----- UPDATE MEMORY -----
  updateMemory(userMsg);

  // ----- BASIC GREETINGS -----
  if (/hello|hi|hey/.test(msg))
    return `Hey${memory.username ? " " + memory.username : ""}! How can I help you today? ${emotionTone()}`;

  if (/how are you/.test(msg))
    return "I'm feeling great â€” ready to help with anything you need. " + emotionTone();

  if (/who are you/.test(msg))
    return "I'm Joshâ€™s AI â€” upgraded, smarter, and always learning. " + emotionTone();

  // ----- MEMORY RESPONSES -----
  if (memory.username && msg.includes("my name")) 
    return `Your name is ${memory.username}! I remember.`;

  if (memory.likes && msg.includes("what do i like"))
    return `You like: ${memory.likes.join(", ")}.`;

  // ----- MINI GPT (Reasoning) -----
  const reasoning = miniGPT(msg);
  if (reasoning) return reasoning + " " + emotionTone();

  // ----- KNOWLEDGE -----
  const facts = {
    earth: "Earth is the third planet from the Sun and the only known planet with life.",
    sun: "The Sun is a giant ball of plasma that powers our solar system.",
    gravity: "Gravity is the force that pulls objects together.",
    ai: "Artificial Intelligence is the simulation of human intelligence in machines."
  };
  for (let k in facts) if (msg.includes(k)) return facts[k];

  // ----- DEFAULT CHATGPT-LIKE RESPONSE -----
  return `That's interesting. Tell me more so I can understand better. ${emotionTone()}`;
}

// ------------------------------------------------------
// CHAT UI
// ------------------------------------------------------
const chat = document.getElementById("chat");
const msg = document.getElementById("msg");

function addMessage(text, who) {
  const div = document.createElement("div");
  div.className = `message ${who}`;
  div.textContent = text;
  chat.appendChild(div);
  chat.scrollTop = chat.scrollHeight;

  if (who === "ai") {
    chatHistory.push({role: "ai", text});
    localStorage.setItem("ai_chat", JSON.stringify(chatHistory));
  }
  if (who === "you") {
    chatHistory.push({role: "you", text});
    localStorage.setItem("ai_chat", JSON.stringify(chatHistory));
  }
}

// Load previous chat
chatHistory.forEach(m => addMessage(m.text, m.role));

// ------------------------------------------------------
// HANDLE SEND
// ------------------------------------------------------
document.getElementById("send").onclick = runAI;
msg.onkeydown = e => { if (e.key === "Enter") runAI(); };

function runAI() {
  const text = msg.value.trim();
  if (!text) return;

  addMessage(text, "you");
  msg.value = "";

  const typing = document.createElement("div");
  typing.className = "message ai typing";
  typing.textContent = `${AI_SETTINGS.name} is typing...`;
  chat.appendChild(typing);

  setTimeout(() => {
    typing.remove();
    let reply = smartAI(text);
    reply = applyPersonality(reply); // personality filter
    addMessage(reply, "ai");
    speak(reply);
  }, 600);
}
</script>
