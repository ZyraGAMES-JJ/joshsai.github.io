<script>
// ======================================================
//        JOSH’S AI — With Groq LLaMA 3.1 Support
// ======================================================

// >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
// INSERT YOUR NEW GROQ KEY HERE (AFTER YOU DELETE OLD ONE)
// >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
const GROQ_API_KEY = "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";

// API Model
const GROQ_MODEL = "llama3-8b-8192"; 

// ======================================================
// PERSONALITY SETTINGS
// ======================================================
const AI_SETTINGS = {
  name: "Josh's AI",
  personality: "calm, intelligent, friendly deep-voiced male",
  memoryEnabled: true,
  historyLimit: 20
};

// Load memory + history
let memory = JSON.parse(localStorage.getItem("ai_memory") || "{}");
let chatHistory = JSON.parse(localStorage.getItem("ai_chat") || "[]");

// ======================================================
// VOICE SYSTEM (Male voice)
// ======================================================
let maleVoice = null;

function loadVoice() {
  const voices = speechSynthesis.getVoices();
  maleVoice =
    voices.find(v => /Male|David|Daniel|Alex|Google UK English Male/i.test(v.name)) ||
    voices[0];
}

speechSynthesis.onvoiceschanged = loadVoice;

function speak(text) {
  const u = new SpeechSynthesisUtterance(text);
  u.voice = maleVoice;
  u.pitch = 0.75;
  u.rate = 1;
  speechSynthesis.speak(u);
}

// ======================================================
// MEMORY HANDLING
// ======================================================
function saveMemory() {
  localStorage.setItem("ai_memory", JSON.stringify(memory));
}

function updateMemory(userMsg) {
  const m = userMsg.toLowerCase();

  if (m.includes("my name is")) {
    memory.username = userMsg.split("my name is")[1].trim();
    saveMemory();
  }

  if (m.includes("i like")) {
    memory.likes = memory.likes || [];
    memory.likes.push(userMsg.split("i like")[1].trim());
    saveMemory();
  }
}

// ======================================================
// OFFLINE MINI-GPT (fallback)
// ======================================================
function miniGPT(prompt) {
  if (prompt.includes("why")) return "Because there's a logical reason behind it.";
  if (prompt.includes("how")) return "Let me break it down in a simple way.";
  if (prompt.includes("what")) return "Here's what you need to know.";
  return "Tell me more so I can help better.";
}

// ======================================================
// GROQ ONLINE AI REQUEST
// ======================================================
async function groqAI(userMsg) {
  try {
    const res = await fetch("https://api.groq.com/openai/v1/chat/completions", {
      method: "POST",
      headers: {
        "Authorization": `Bearer ${GROQ_API_KEY}`,
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
        model: GROQ_MODEL,
        messages: buildChatHistory(userMsg),
        temperature: 0.8
      })
    });

    const data = await res.json();
    return data.choices?.[0]?.message?.content || null;

  } catch {
    return null; // fallback to offline brain
  }
}

function buildChatHistory(userMsg) {
  const messages = chatHistory
    .slice(-AI_SETTINGS.historyLimit)
    .map(m => ({
      role: m.role === "you" ? "user" : "assistant",
      content: m.text
    }));

  messages.push({ role: "user", content: userMsg });

  return messages;
}

// ======================================================
// MAIN BRAIN
// ======================================================
async function smartAI(userMsg) {
  const msg = userMsg.toLowerCase();

  // Command: /clear
  if (msg.startsWith("/clear")) {
    localStorage.setItem("ai_chat", JSON.stringify([]));
    chatHistory = [];
    return "Chat cleared! Ready to start fresh.";
  }

  // Update memory
  updateMemory(userMsg);

  // Try Groq online AI first
  const online = await groqAI(userMsg);
  if (online) return online;

  // Offline fallback
  return miniGPT(msg);
}

// ======================================================
// CHAT UI
// ======================================================
const chat = document.getElementById("chat");
const msg = document.getElementById("msg");

function addMessage(text, who) {
  const div = document.createElement("div");
  div.className = `message ${who}`;
  div.textContent = text;
  chat.appendChild(div);
  chat.scrollTop = chat.scrollHeight;

  chatHistory.push({role: who, text});
  localStorage.setItem("ai_chat", JSON.stringify(chatHistory));
}

// Load old chat
chatHistory.forEach(m => addMessage(m.text, m.role));

document.getElementById("send").onclick = runAI;
msg.onkeydown = e => { if (e.key === "Enter") runAI(); };

async function runAI() {
  const text = msg.value.trim();
  if (!text) return;

  addMessage(text, "you");
  msg.value = "";

  const typing = document.createElement("div");
  typing.className = "message ai typing";
  typing.textContent = "Josh's AI is thinking...";
  chat.appendChild(typing);

  const reply = await smartAI(text);

  typing.remove();
  addMessage(reply, "ai");
  speak(reply);
}
</script>
